From bffaad099256c02bc634505dbe8f2e4ae47b16ad Mon Sep 17 00:00:00 2001
From: Chris Feist <cfeist@redhat.com>
Date: Tue, 21 Apr 2015 16:47:17 -0500
Subject: [PATCH] Don't allow adding duplicate actions for the same resource

---
 ricci/ccs/ccs                         | 8 ++++++++
 ricci/ccs/unit_tests/service.conf.end | 3 ++-
 ricci/ccs/unit_tests/unittest.pl      | 6 ++++--
 3 files changed, 14 insertions(+), 3 deletions(-)

diff --git a/ricci/ccs/ccs b/ricci/ccs/ccs
index 8bab523..53495ab 100755
--- a/ricci/ccs/ccs
+++ b/ricci/ccs/ccs
@@ -1717,6 +1717,14 @@ def add_action(resname, options):
         sys.exit(1)
 
     resElem = elems[0]
+
+    for elem in resElem.childNodes:
+        if elem.nodeType != minidom.Node.ELEMENT_NODE:
+            continue
+        if elem.tagName == "action" and elem.attributes["name"].value == action_name:
+            print "Error: '%s' action already exists for '%s'" % (action_name, resname)
+            sys.exit(1)
+
     actionElem = dom.createElement("action")
     actionElem.setAttribute("name",action_name)
     resElem.appendChild(actionElem)
diff --git a/ricci/ccs/unit_tests/service.conf.end b/ricci/ccs/unit_tests/service.conf.end
index 8178f5e..2e21efb 100644
--- a/ricci/ccs/unit_tests/service.conf.end
+++ b/ricci/ccs/unit_tests/service.conf.end
@@ -1,4 +1,4 @@
-<cluster config_version="52" name="mycluster">
+<cluster config_version="53" name="mycluster">
   <fence_daemon/>
   <clusternodes>
     <clusternode name="node1" nodeid="1"/>
@@ -44,6 +44,7 @@
       </nfsclient>
     </service>
     <vm autostart="1" migrate="live" name="vmname2">
+      <action name="start" timeout="5m"/>
       <action name="stop" timeout="5m"/>
     </vm>
     <vm autostart="0" migrate="live" name="vmname3">
diff --git a/ricci/ccs/unit_tests/unittest.pl b/ricci/ccs/unit_tests/unittest.pl
index 9869cff..a731dbf 100755
--- a/ricci/ccs/unit_tests/unittest.pl
+++ b/ricci/ccs/unit_tests/unittest.pl
@@ -213,9 +213,11 @@ sub service_test {
   test ("$CCS -f $t --addaction vmname1 stop timeout=10m",0);
   test ("$CCS -f $t --addaction vmname1 stop2 timeout=11m",0);
   test ("$CCS -f $t --addaction vmname1 stop3 timeout=12m",0);
+  test ("$CCS -f $t --addaction vmname2 start timeout=5m",0);
+  test ("$CCS -f $t --addaction vmname2 stop timeout=5m",0);
+  test ("$CCS -f $t --addaction vmname2 stop timeout=6m",1);
+  test ("$CCS -f $t --rmaction vmname2 stop timeout=5m",0);
   test ("$CCS -f $t --addaction vmname2 stop timeout=5m",0);
-  test ("$CCS -f $t --addaction vmname2 stop timeout=6m",0);
-  test ("$CCS -f $t --rmaction vmname2 stop timeout=6m",0);
   test ("$CCS -f $t --addaction vmname3 stop timeout=3m",0);
   test ("$CCS -f $t --rmaction vmname3 stop timeout=4m",1);
   test ("$CCS -f $t --rmaction vmname4 stop timeout=3m",1);
-- 
2.1.0

